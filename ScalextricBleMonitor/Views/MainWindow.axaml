<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="using:ScalextricBleMonitor.ViewModels"
        xmlns:conv="using:ScalextricBleMonitor.Converters"
        mc:Ignorable="d" d:DesignWidth="500" d:DesignHeight="480"
        x:Class="ScalextricBleMonitor.Views.MainWindow"
        x:DataType="vm:MainViewModel"
        Title="Scalextric ARC Pro BLE Monitor"
        Width="500" Height="480"
        MinWidth="400" MinHeight="400"
        WindowStartupLocation="CenterScreen">

    <Design.DataContext>
        <vm:MainViewModel />
    </Design.DataContext>

    <Grid RowDefinitions="Auto,Auto,*,Auto" Margin="15">

        <!-- Header: Title + Connection Status -->
        <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto" Margin="0,0,0,10">
            <!-- Status indicator -->
            <Ellipse Grid.Column="0"
                     Width="24" Height="24"
                     Fill="{Binding StatusIndicatorBrush}"
                     VerticalAlignment="Center"/>

            <!-- Title and status -->
            <StackPanel Grid.Column="1" Margin="12,0" VerticalAlignment="Center">
                <TextBlock Text="Scalextric ARC Pro BLE Monitor"
                           FontSize="16"
                           FontWeight="SemiBold"/>
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="{Binding ConnectionStatusText}"
                               FontSize="12"
                               Foreground="{Binding StatusTextBrush}"/>
                    <TextBlock Text="{Binding DeviceName}"
                               FontSize="12"
                               Foreground="Gray"
                               IsVisible="{Binding IsConnected}"/>
                </StackPanel>
            </StackPanel>

            <!-- Legend tooltip area -->
            <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="6" VerticalAlignment="Center">
                <Ellipse Width="10" Height="10" Fill="#DC3545" ToolTip.Tip="Not Found"/>
                <Ellipse Width="10" Height="10" Fill="#00C853" ToolTip.Tip="Detected (Advertisement)"/>
                <Ellipse Width="10" Height="10" Fill="#0096FF" ToolTip.Tip="GATT Connected"/>
            </StackPanel>
        </Grid>

        <!-- Status message bar -->
        <Border Grid.Row="1"
                Background="#F5F5F5"
                CornerRadius="4"
                Padding="10,6"
                Margin="0,0,0,10">
            <TextBlock Text="{Binding StatusText}"
                       FontSize="11"
                       Foreground="#666666"
                       TextWrapping="NoWrap"
                       TextTrimming="CharacterEllipsis"/>
        </Border>

        <!-- Main Content: Power Control + Controllers -->
        <Border Grid.Row="2"
                Background="#FAFAFA"
                CornerRadius="8"
                Padding="12">
            <Grid RowDefinitions="Auto,*">
                <!-- Power Control (compact horizontal layout) -->
                <Border Grid.Row="0"
                        Background="#F0F0F0"
                        CornerRadius="4"
                        Padding="10,8"
                        Margin="0,0,0,10"
                        IsVisible="{Binding IsGattConnected}">
                    <Grid ColumnDefinitions="Auto,Auto,*,Auto">
                        <!-- Power button -->
                        <Button Grid.Column="0"
                                Content="{Binding IsPowerEnabled, Converter={x:Static conv:PowerButtonTextConverter.Instance}}"
                                Command="{Binding TogglePowerCommand}"
                                Padding="12,6"
                                FontWeight="Bold"
                                FontSize="12"
                                MinWidth="90"/>

                        <!-- Per-slot toggle -->
                        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4" Margin="12,0,0,0" VerticalAlignment="Center">
                            <ToggleButton IsChecked="{Binding UsePerSlotPower}"
                                          Content="{Binding UsePerSlotPower, Converter={x:Static conv:PerSlotToggleTextConverter.Instance}}"
                                          Padding="8,4"
                                          FontSize="10"
                                          ToolTip.Tip="Toggle between global power level and per-slot power levels"/>
                        </StackPanel>

                        <!-- Global power slider (only visible when per-slot is disabled) -->
                        <StackPanel Grid.Column="2" Orientation="Horizontal" HorizontalAlignment="Center" Spacing="8"
                                    IsVisible="{Binding !UsePerSlotPower}">
                            <TextBlock Text="Level:"
                                       FontSize="11"
                                       VerticalAlignment="Center"
                                       Foreground="#666666"/>
                            <Slider Minimum="0"
                                    Maximum="63"
                                    Value="{Binding PowerLevel}"
                                    Width="120"
                                    VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding PowerLevel}"
                                       FontSize="11"
                                       FontWeight="Bold"
                                       VerticalAlignment="Center"
                                       Width="20"/>
                        </StackPanel>

                        <!-- Power indicator -->
                        <Ellipse Grid.Column="3"
                                 Width="12" Height="12"
                                 VerticalAlignment="Center">
                            <Ellipse.Fill>
                                <SolidColorBrush Color="{Binding IsPowerEnabled, Converter={x:Static conv:PowerIndicatorColorConverter.Instance}}"/>
                            </Ellipse.Fill>
                        </Ellipse>
                    </Grid>
                </Border>

                <!-- Controllers Status (compact) -->
                <ItemsControl Grid.Row="1"
                              ItemsSource="{Binding Controllers}"
                              IsVisible="{Binding IsGattConnected}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="vm:ControllerViewModel">
                            <Border Background="#F5F5F5"
                                    CornerRadius="3"
                                    Padding="6,4"
                                    Margin="0,1">
                                <Grid ColumnDefinitions="22,Auto,*,Auto">
                                    <!-- Slot number -->
                                    <TextBlock Grid.Column="0"
                                               Text="{Binding SlotNumber, StringFormat='C{0}'}"
                                               FontWeight="Bold"
                                               FontSize="11"
                                               Foreground="#0096FF"
                                               VerticalAlignment="Center"/>

                                    <!-- Per-slot power control (only visible in per-slot mode) -->
                                    <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="2" Margin="4,0" VerticalAlignment="Center"
                                                IsVisible="{ReflectionBinding DataContext.UsePerSlotPower, RelativeSource={RelativeSource AncestorType=ItemsControl}}">
                                        <!-- Ghost mode toggle -->
                                        <ToggleButton IsChecked="{Binding IsGhostMode}"
                                                      Content="G"
                                                      Padding="4,2"
                                                      FontSize="9"
                                                      FontWeight="Bold"
                                                      MinWidth="20"
                                                      ToolTip.Tip="Ghost Mode: Car runs autonomously at set throttle level without controller input"/>
                                        <!-- Power control - hidden when ghost mode is on -->
                                        <TextBlock Text="P:"
                                                   FontSize="9"
                                                   Foreground="#666666"
                                                   VerticalAlignment="Center"
                                                   Margin="4,0,0,0"
                                                   IsVisible="{Binding !IsGhostMode}"/>
                                        <Slider Minimum="0"
                                                Maximum="63"
                                                Value="{Binding PowerLevel}"
                                                Width="50"
                                                VerticalAlignment="Center"
                                                IsVisible="{Binding !IsGhostMode}"
                                                ToolTip.Tip="Max power multiplier for controller input"/>
                                        <TextBlock Text="{Binding PowerLevel}"
                                                   FontSize="9"
                                                   FontWeight="Bold"
                                                   Foreground="#0096FF"
                                                   VerticalAlignment="Center"
                                                   Width="16"
                                                   IsVisible="{Binding !IsGhostMode}"/>
                                        <!-- Ghost mode indicator when active -->
                                        <TextBlock Text="Ghost"
                                                   FontSize="9"
                                                   FontWeight="Bold"
                                                   Foreground="#4CAF50"
                                                   VerticalAlignment="Center"
                                                   Margin="4,0,0,0"
                                                   IsVisible="{Binding IsGhostMode}"
                                                   ToolTip.Tip="Use Ghost Control window to set throttle level"/>
                                        <!-- Throttle Profile selector -->
                                        <ComboBox ItemsSource="{x:Static vm:ControllerViewModel.AvailableProfiles}"
                                                  SelectedItem="{Binding ThrottleProfile}"
                                                  FontSize="9"
                                                  Padding="4,2"
                                                  MinWidth="80"
                                                  Margin="4,0,0,0"
                                                  ToolTip.Tip="Throttle response curve (applied on next power enable)"/>
                                    </StackPanel>

                                    <!-- Throttle bar -->
                                    <Grid Grid.Column="2" Margin="4,0">
                                        <Border Background="#E0E0E0"
                                                CornerRadius="2"
                                                Height="14"/>
                                        <Border Background="#4CAF50"
                                                CornerRadius="2"
                                                Height="14"
                                                HorizontalAlignment="Stretch"
                                                RenderTransformOrigin="0,0.5">
                                            <Border.RenderTransform>
                                                <ScaleTransform ScaleX="{Binding Throttle, Converter={x:Static conv:ThrottleToScaleConverter.Instance}}"/>
                                            </Border.RenderTransform>
                                        </Border>
                                        <TextBlock Text="{Binding Throttle}"
                                                   FontSize="9"
                                                   FontWeight="Bold"
                                                   Foreground="White"
                                                   HorizontalAlignment="Center"
                                                   VerticalAlignment="Center"/>
                                    </Grid>

                                    <!-- Brake/Lane change/Lap indicators -->
                                    <StackPanel Grid.Column="3" Orientation="Horizontal" Spacing="3">
                                        <Border Background="{Binding IsBrakePressed, Converter={x:Static conv:BoolToBrushConverter.BrakeInstance}}"
                                                CornerRadius="2"
                                                Padding="3,1"
                                                MinWidth="30">
                                            <TextBlock Text="{Binding BrakeCount, StringFormat='B:{0}'}"
                                                       FontSize="8"
                                                       Foreground="White"
                                                       HorizontalAlignment="Center"/>
                                        </Border>
                                        <Border Background="{Binding IsLaneChangePressed, Converter={x:Static conv:BoolToBrushConverter.LaneChangeInstance}}"
                                                CornerRadius="2"
                                                Padding="3,1"
                                                MinWidth="30">
                                            <TextBlock Text="{Binding LaneChangeCount, StringFormat='LC:{0}'}"
                                                       FontSize="8"
                                                       Foreground="White"
                                                       HorizontalAlignment="Center"/>
                                        </Border>
                                        <Border Background="#FF9800"
                                                CornerRadius="2"
                                                Padding="3,1"
                                                MinWidth="30"
                                                ToolTip.Tip="Current Lap">
                                            <TextBlock Text="{Binding CurrentLap, StringFormat='L:{0}'}"
                                                       FontSize="8"
                                                       Foreground="White"
                                                       HorizontalAlignment="Center"/>
                                        </Border>
                                        <Border Background="#4CAF50"
                                                CornerRadius="2"
                                                Padding="3,1"
                                                MinWidth="42"
                                                ToolTip.Tip="Last Lap Time">
                                            <TextBlock Text="{Binding LapTimeDisplay}"
                                                       FontSize="8"
                                                       Foreground="White"
                                                       HorizontalAlignment="Center"/>
                                        </Border>
                                        <Border Background="#9C27B0"
                                                CornerRadius="2"
                                                Padding="3,1"
                                                MinWidth="42"
                                                ToolTip.Tip="Best Lap Time">
                                            <TextBlock Text="{Binding BestLapTimeDisplay}"
                                                       FontSize="8"
                                                       Foreground="White"
                                                       HorizontalAlignment="Center"/>
                                        </Border>
                                        <Border Background="#607D8B"
                                                CornerRadius="2"
                                                Padding="3,1"
                                                MinWidth="24"
                                                ToolTip.Tip="Current Lane">
                                            <TextBlock Text="{Binding LaneDisplay}"
                                                       FontSize="8"
                                                       Foreground="White"
                                                       HorizontalAlignment="Center"/>
                                        </Border>
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <!-- Placeholder when not connected -->
                <StackPanel Grid.Row="1"
                            IsVisible="{Binding !IsGattConnected}"
                            VerticalAlignment="Center"
                            HorizontalAlignment="Center"
                            Spacing="8">
                    <TextBlock Text="Waiting for GATT connection..."
                               FontSize="13"
                               Foreground="Gray"
                               HorizontalAlignment="Center"/>
                    <TextBlock Text="Controller data will appear here when connected"
                               FontSize="11"
                               Foreground="#AAAAAA"
                               HorizontalAlignment="Center"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Bottom: Action Buttons -->
        <StackPanel Grid.Row="3"
                    Orientation="Horizontal"
                    HorizontalAlignment="Center"
                    Spacing="10"
                    Margin="0,10,0,0">
            <Button Content="GATT Services"
                    Command="{Binding ShowGattServicesCommand}"
                    Padding="20,10"
                    FontSize="12"
                    IsEnabled="{Binding !IsGattServicesWindowOpen}"/>
            <Button Content="Live Notifications"
                    Command="{Binding ShowNotificationsCommand}"
                    Padding="20,10"
                    FontSize="12"
                    IsEnabled="{Binding !IsNotificationWindowOpen}"/>
            <Button Content="Ghost Control"
                    Command="{Binding ShowGhostControlCommand}"
                    Padding="20,10"
                    FontSize="12"
                    IsEnabled="{Binding !IsGhostControlWindowOpen}"/>
        </StackPanel>
    </Grid>
</Window>
